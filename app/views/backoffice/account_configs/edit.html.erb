<!-- Header -->
<header class="sticky -top-6 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md px-4 pt-4 pb-2 mb-4">
  <div class="flex items-center gap-4">
    <%= render 'shared/ui/back_link', path: backoffice_account_config_path, only_icon: true %>
    <%= render 'shared/ui/heading',
        text: "Editar configurações",
        size: :lg %>
  </div>
</header>

<main class="max-w-2xl mx-auto pb-32">
  <%= form_with model: [@account_config], url: backoffice_account_config_path, local: true, data: { controller: "account-config-form" } do |f| %>
    <!-- Info Card -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4">
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Ajuste as preferências da sua conta: metas, alertas, formas de pagamento,
          obrigatoriedade de cliente e variações de produto.
        </p>
      </div>
    </section>

    <!-- Goals Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Metas",
              size: :md %>
        </div>

        <div class="space-y-3">
          <%= render 'shared/ui/form_input',
              form: f,
              field: :daily_goal,
              label: "Meta diária (R$)",
              type: :number,
              step: 0.01,
              min: 0,
              placeholder: "0,00" %>

          <%= render 'shared/ui/form_input',
              form: f,
              field: :weekly_goal,
              label: "Meta semanal (R$) (opcional)",
              type: :number,
              step: 0.01,
              min: 0,
              placeholder: "0,00" %>

          <%= render 'shared/ui/form_input',
              form: f,
              field: :monthly_goal,
              label: "Meta mensal (R$) (opcional)",
              type: :number,
              step: 0.01,
              min: 0,
              placeholder: "0,00" %>
        </div>
      </div>
    </section>

    <!-- Stock Alerts Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Alertas de estoque",
              size: :md %>
        </div>

        <%= render 'shared/ui/toggle',
            form: f,
            field: :stock_alerts_enabled,
            label: "Ativar alertas de estoque baixo",
            hint: "Você será avisado quando o estoque estiver abaixo do limite escolhido." %>

        <%= render 'shared/ui/form_input',
            form: f,
            field: :stock_alert_threshold,
            label: "Quantidade mínima para alerta",
            type: :number,
            step: 1,
            min: 1,
            placeholder: "3" %>
      </div>
    </section>

    <!-- Payment Methods Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Formas de pagamento",
              size: :md %>
        </div>

        <div class="space-y-3">
          <%= render 'shared/ui/toggle',
              form: f,
              field: :pix_enabled,
              label: "PIX",
              hint: "Mostrar PIX como forma de pagamento na venda." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :card_enabled,
              label: "Cartão",
              hint: "Mostrar cartão (crédito/débito) como forma de pagamento." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :cash_enabled,
              label: "Dinheiro",
              hint: "Mostrar dinheiro como forma de pagamento." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :fiado_enabled,
              label: "Fiado",
              hint: "Permitir vendas fiado (cliente obrigatório)." %>
        </div>
      </div>
    </section>

    <!-- Preferences Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Preferências de venda",
              size: :md %>
        </div>

        <div class="space-y-3">
          <%= render 'shared/ui/toggle',
              form: f,
              field: :require_customer,
              label: "Exigir cliente em toda venda",
              hint: "Quando ativo, toda venda precisa ter um cliente selecionado." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :auto_send_payment_link,
              label: "Enviar link de pagamento automaticamente",
              hint: "Quando possível, envia o link de pagamento por WhatsApp automaticamente." %>
        </div>
      </div>
    </section>

    <!-- Import Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Importação de produtos",
              size: :md %>
        </div>
        <p class="text-sm text-zinc-600 dark:text-zinc-400 mb-4">
          Valores padrão usados na tela de nova importação. Podem ser alterados a cada importação.
        </p>
        <div class="space-y-3">
          <%= render 'shared/ui/toggle',
              form: f,
              field: :product_import_auto_generate_sku,
              label: "Gerar SKUs automaticamente",
              hint: "Se o produto não tiver SKU, será gerado automaticamente." %>

          <%= render 'shared/ui/form_select',
              form: f,
              field: :product_import_sku_generation_mode,
              label: "Forma de geração de SKU",
              options: [
                ["Começo do nome", "name_prefix"],
                ["Apenas números", "numbers_only"],
                ["Números e letras aleatórias", "numbers_and_letters"]
              ],
              prompt: "Começo do nome",
              hint: "Define como o SKU é gerado quando não informado no arquivo." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :product_import_ignore_errors,
              label: "Ignorar linhas com erro",
              hint: "Importa apenas as linhas válidas. Se desmarcado, só importa se tudo estiver correto." %>

          <%= render 'shared/ui/toggle',
              form: f,
              field: :product_import_prevent_duplicate_names,
              label: "Não permitir nomes repetidos",
              hint: "Valida nomes duplicados e impede a importação de produtos com o mesmo nome." %>

          <%= render 'shared/ui/form_select',
              form: f,
              field: :product_import_name_normalization,
              label: "Normalizar nome do produto",
              options: [
                ["Manter como no CSV", "none"],
                ["Todas maiúsculas", "uppercase"],
                ["Primeira letra maiúscula", "sentence"],
                ["Título (cada palavra maiúscula)", "title"]
              ],
              prompt: "Manter como no CSV",
              hint: "Aplica esta formatação ao nome de cada produto ao importar." %>
        </div>
      </div>
    </section>

    <!-- Sizes Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-4">
          <%= render 'shared/ui/heading',
              text: "Tamanhos",
              size: :md %>
          <div class="flex items-center gap-2">
            <button type="button" 
                    class="text-sm text-primary hover:text-primary-dark font-medium"
                    data-action="click->account-config-form#selectAllSizes">
              Selecionar todos
            </button>
            <span class="text-zinc-400">|</span>
            <button type="button" 
                    class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 font-medium"
                    data-action="click->account-config-form#deselectAllSizes">
              Limpar
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-2">
          <% ProductVariations::SIZES.each_with_index do |size, index| %>
            <label class="cursor-pointer">
              <%= check_box_tag "account_config[enabled_sizes][]", 
                  size, 
                  @account_config.enabled_sizes_list.include?(size),
                  id: "size_#{index}",
                  class: "hidden",
                  data: { 
                    account_config_form_target: "sizeCheckbox",
                    action: "change->account-config-form#updateSizeCount"
                  } %>
              <div class="size-chip px-3 py-1.5 rounded-full text-sm font-medium transition-all border-2 <%= @account_config.enabled_sizes_list.include?(size) ? 'bg-primary text-white border-primary' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 border-transparent hover:border-primary/50' %>"
                   data-action="click->account-config-form#toggleSize">
                <%= size %>
              </div>
            </label>
          <% end %>
        </div>
        <p class="text-xs text-zinc-500 mt-3">
          <span data-account-config-form-target="sizeCount">0</span> tamanhos selecionados
        </p>
      </div>
    </section>

    <!-- Colors Section -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-4">
          <%= render 'shared/ui/heading',
              text: "Cores",
              size: :md %>
          <div class="flex items-center gap-2">
            <button type="button" 
                    class="text-sm text-primary hover:text-primary-dark font-medium"
                    data-action="click->account-config-form#selectAllColors">
              Selecionar todas
            </button>
            <span class="text-zinc-400">|</span>
            <button type="button" 
                    class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 font-medium"
                    data-action="click->account-config-form#deselectAllColors">
              Limpar
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-2">
          <% ProductVariations::COLORS.each_with_index do |color, index| %>
            <label class="cursor-pointer">
              <%= check_box_tag "account_config[enabled_colors][]", 
                  color, 
                  @account_config.enabled_colors_list.include?(color),
                  id: "color_#{index}",
                  class: "hidden",
                  data: { 
                    account_config_form_target: "colorCheckbox",
                    action: "change->account-config-form#updateColorCount"
                  } %>
              <div class="color-chip px-3 py-1.5 rounded-full text-sm font-medium transition-all border-2 <%= @account_config.enabled_colors_list.include?(color) ? 'bg-primary text-white border-primary' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 border-transparent hover:border-primary/50' %>"
                   data-action="click->account-config-form#toggleColor">
                <%= color %>
              </div>
            </label>
          <% end %>
        </div>
        <p class="text-xs text-zinc-500 mt-3">
          <span data-account-config-form-target="colorCount">0</span> cores selecionadas
        </p>
      </div>
    </section>

    <!-- Logo da loja -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Logo da loja",
              size: :md %>
        </div>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Logo usado na loja e nas etiquetas de produtos (opcional). Se não houver upload, as etiquetas não exibem logo.
        </p>
        <%= f.fields_for :account, current_account do |af| %>
          <%= render 'shared/ui/image_upload',
              form: af,
              field: :logo,
              existing_image: current_account.logo.attached? ? current_account.logo : nil,
              multiple: false,
              preview_class: "w-full h-32 max-w-xs mx-auto" %>
        <% end %>
      </div>
    </section>

    <!-- Etiquetas de produtos -->
    <section class="px-4 mb-6">
      <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <%= render 'shared/ui/heading',
              text: "Etiquetas de produtos",
              size: :md %>
        </div>
        <p class="text-sm text-zinc-600 dark:text-zinc-400">
          Escolha quais informações aparecem nas etiquetas ao imprimir. O logo da loja pode ser exibido no topo (configure o logo acima).
        </p>
        <%= render 'shared/ui/toggle',
            form: f,
            field: :label_show_logo,
            label: "Mostrar logo da loja na etiqueta",
            hint: "Exibe o logo da conta no topo de cada etiqueta." %>
        <div>
          <p class="text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">Campos a exibir na etiqueta</p>
          <div class="flex flex-wrap gap-3">
            <% AccountConfig::LABEL_AVAILABLE_FIELDS.each do |field_key| %>
              <label class="inline-flex items-center gap-2 cursor-pointer">
                <%= check_box_tag "account_config[label_fields][]",
                    field_key,
                    @account_config.label_fields.include?(field_key),
                    id: "label_field_#{field_key}" %>
                <span class="text-sm text-zinc-700 dark:text-zinc-300"><%= AccountConfig::LABEL_FIELD_LABELS[field_key] || field_key.humanize %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>
    </section>

    <!-- Fixed Footer -->
    <div class="fixed-footer">
      <%= render 'shared/ui/button',
          text: "Salvar configurações",
          variant: :primary,
          size: :lg,
          type: :submit,
          form: f,
          class: "w-full" %>
    </div>
  <% end %>
</main>
