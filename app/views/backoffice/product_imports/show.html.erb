<div class="flex flex-col h-[calc(100vh-6rem)] md:h-[calc(100vh-2rem)] max-w-7xl mx-auto px-4">
  <!-- Header -->
  <header class="flex-shrink-0 pt-4 pb-2 mb-2">
    <div class="flex items-center gap-4">
      <%= render 'shared/ui/back_link', path: backoffice_products_path, only_icon: true %>
      <%= render 'shared/ui/heading',
          text: "Revisar importação",
          size: :lg %>
    </div>
  </header>

  <script>
  window.productImportData = {
    rows: <%= raw @product_import.parsed_data.to_json %>,
    errors: <%= raw @product_import.import_errors.to_json %>,
    automatic_pricing: {
      enabled: <%= @account_config.automatic_pricing_enabled %>,
      markup_percent: <%= @account_config.automatic_pricing_markup_percent&.to_f || 35 %>,
      rounding_mode: <%= raw (@account_config.automatic_pricing_rounding_mode || 'up_9_90').to_json %>,
      use_csv_when_cost_empty: <%= @account_config.automatic_pricing_use_csv_when_cost_empty %>
    }
  };
</script>
<%= tag.script(
  @product_import.parsed_data.to_json.html_safe,
  type: "application/json",
  id: "import-rows-data"
) %>
<script>
  document.addEventListener("turbo:before-stream-render", function(event) {
    var newStream = event.detail.newStream;
    var targetId = newStream.getAttribute ? newStream.getAttribute("target") : null;
    if (targetId === "import-rows-data") {
      var originalRender = event.detail.render;
      event.detail.render = function(currentElement) {
        var p = originalRender(currentElement);
        if (p && p.then) {
          return p.then(function() {
            var el = document.getElementById("import-rows-data");
            if (el && el.textContent && window.Alpine) {
              try {
                var newRows = JSON.parse(el.textContent);
                var main = document.getElementById("import-review-main");
                if (main && Alpine.$data(main)) Alpine.$data(main).rows = newRows;
              } catch (e) {}
            }
          });
        }
        var el = document.getElementById("import-rows-data");
        if (el && el.textContent && window.Alpine) {
          try {
            var newRows = JSON.parse(el.textContent);
            var main = document.getElementById("import-review-main");
            if (main && Alpine.$data(main)) Alpine.$data(main).rows = newRows;
          } catch (e) {}
        }
        return p;
      };
    }
  });
</script>

  <main id="import-review-main" class="flex-1 min-h-0 flex flex-col overflow-hidden" x-data="productImportReview()">
  <!-- Alerta de Conflitos de Nomes: no mobile só o título; no desktop collapsible completo -->
  <div class="mb-6 flex-shrink-0" x-show="hasNameConflicts()" x-transition x-data="{ open: false }">
    <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-700 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <div class="shrink-0 hidden md:block">
          <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/40 flex items-center justify-center">
            <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold text-red-900 dark:text-red-100">
            ⚠️ Conflitos de nomes detectados
          </p>
          <p class="text-xs text-red-700 dark:text-red-300 mb-2 hidden md:block">
            Existem produtos com nomes duplicados na importação. Corrija os nomes antes de continuar.
          </p>
          <button type="button"
                  @click="open = !open"
                  class="hidden md:flex items-center gap-1.5 text-xs font-medium text-red-700 dark:text-red-300 hover:text-red-800 dark:hover:text-red-200 focus:outline-none focus:ring-2 focus:ring-red-400 rounded px-2 py-1 -ml-2">
            <span x-text="open ? 'Ocultar detalhes' : 'Ver detalhes'"></span>
            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div x-show="open"
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0"
               x-transition:enter-end="opacity-100"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100"
               x-transition:leave-end="opacity-0"
               class="hidden md:block space-y-2 mt-3 max-h-48 overflow-y-auto">
            <template x-for="conflict in getNameConflicts()" :key="'conflict-' + conflict.row">
              <div class="text-xs bg-red-100 dark:bg-red-900/30 rounded p-2 border border-red-200 dark:border-red-800">
                <span class="font-semibold text-red-900 dark:text-red-100">Linha <span x-text="conflict.row"></span>:</span>
                <ul class="list-disc list-inside ml-2 mt-1 space-y-0.5">
                  <template x-for="error in conflict.errors.filter(e => typeof e === 'string' && (e.includes('nome') || e.includes('Nome') || e.includes('já existe') || e.includes('duplicado')))" :key="error">
                    <li class="text-red-700 dark:text-red-300" x-text="error"></li>
                  </template>
                </ul>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Informações da Importação + Precificação na mesma linha -->
  <div class="mb-6 flex-shrink-0">
    <%= render 'shared/ui/card' do %>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
        <div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Tipo de arquivo</p>
          <p class="font-semibold text-slate-900 dark:text-slate-100"><%= @product_import.source_type.upcase %></p>
        </div>
        <div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Total de linhas</p>
          <p class="font-semibold text-slate-900 dark:text-slate-100"><%= @product_import.total_rows || 0 %></p>
        </div>
        <div>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Status</p>
          <%= render 'shared/ui/badge',
              text: @product_import.status_label,
              variant: @product_import.status == 'ready' ? :success : (@product_import.status == 'failed' ? :error : :warning) %>
        </div>
        <div class="md:border-l md:border-slate-200 dark:md:border-slate-700 md:pl-6">
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Precificação automática</p>
          <div class="flex items-center gap-3 flex-wrap">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox"
                     class="sr-only peer"
                     x-model="automaticPricingEnabled" />
              <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
            </label>
            <template x-if="automaticPricingEnabled">
              <div class="flex flex-wrap gap-2 items-center">
                <%= link_to backoffice_product_import_pricing_path(@product_import),
                    data: { turbo_frame: "pricing_modal_placeholder" },
                    class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-slate-700 dark:text-slate-300 no-underline" do %>
                  <span class="material-symbols-outlined text-sm">settings</span>
                  Configurar
                <% end %>
                <%= button_to apply_backoffice_product_import_pricing_path(@product_import, format: :turbo_stream),
                    method: :post,
                    class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors border-0 cursor-pointer" do %>
                  <span class="material-symbols-outlined text-sm">auto_fix_high</span>
                  Aplicar na tabela
                <% end %>
              </div>
            </template>
          </div>
          <div x-show="automaticPricingEnabled && pricingConfig.markup_percent != null && pricingConfig.rounding_mode"
               class="mt-2 flex items-center gap-2 text-[11px] text-slate-500 bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
            <span class="material-symbols-outlined text-sm text-primary">info</span>
            <span>Markup: <strong class="text-slate-700 dark:text-slate-300" x-text="pricingConfig.markup_percent + '%'"></strong> · Arred.: <strong class="text-slate-700 dark:text-slate-300" x-text="roundingModeLabel(pricingConfig.rounding_mode)"></strong></span>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Modal de precificação (carregado no frame ao clicar em "Configurar") -->
  <div class="flex-shrink-0"><%= turbo_frame_tag "pricing_modal_placeholder" %></div>

  <!-- Formulário de Edição -->
  <%= form_with model: @product_import, url: backoffice_product_import_path(@product_import), method: :patch, local: true, id: "import-form", class: "flex flex-col flex-1 min-h-0" do |f| %>
    <!-- Tabela Editável (altura mínima no mobile para a tabela ficar utilizável) -->
    <div class="flex-1 flex flex-col min-h-[300px]">
      <%= render 'shared/ui/card', class: "flex-1 min-h-0 flex flex-col !p-0", body_class: "flex-1 min-h-0 flex flex-col overflow-hidden p-4" do %>
        <div class="import-table-scroll flex-1 overflow-auto min-h-[180px] md:min-h-0">
          <table class="w-full min-w-max">
            <thead>
              <tr class="border-b border-slate-200 dark:border-slate-700">
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[200px]">Nome</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[250px]">Descrição</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[120px]">SKU</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[100px]">Preço Custo</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[100px]">Preço Venda</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[120px]">Categoria</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[150px]">Marca</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[120px]">Cor</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[100px]">Tamanho</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[90px]">Estoque</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[70px]">Ativo</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700 dark:text-slate-300 min-w-[150px]">Erros</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(row, index) in rows" :key="index">
                <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50"
                    :class="{ 'bg-red-50 dark:bg-red-900/10': hasErrors(index) }">
                  <td class="py-3 px-4 min-w-[200px]">
                    <input type="text"
                           x-model="row.nome"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary"
                           required>
                  </td>
                  <td class="py-3 px-4 min-w-[250px]">
                    <input type="text"
                           x-model="row.descricao"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[120px]">
                    <input type="text"
                           x-model="row.sku"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[100px]">
                    <input type="number"
                           x-model.number="row.preco_custo"
                           step="0.01"
                           min="0"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[100px]">
                    <div class="flex items-center gap-2 flex-wrap">
                      <input type="number"
                             x-model.number="row.preco_venda"
                             step="0.01"
                             min="0"
                             class="w-full min-w-0 px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                      <span x-show="row.preco_venda_auto || row.preco_base_auto || row._auto_price"
                            class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300"
                            style="display: none;">AUTO</span>
                    </div>
                  </td>
                  <td class="py-3 px-4 min-w-[120px]">
                    <input type="text"
                           x-model="row.categoria"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[150px]">
                    <input type="text"
                           x-model="row.marca"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[120px]">
                    <input type="text"
                           x-model="row.cor"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[100px]">
                    <input type="text"
                           x-model="row.tamanho"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary">
                  </td>
                  <td class="py-3 px-4 min-w-[90px]">
                    <input type="number"
                           x-model.number="row.quantidade_estoque"
                           min="0"
                           class="w-full px-2 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary"
                           required>
                  </td>
                  <td class="py-3 px-4 min-w-[70px]">
                    <label class="relative flex h-6 w-11 cursor-pointer items-center rounded-full border-none bg-slate-200 dark:bg-slate-700 p-0.5 transition-all"
                           :class="row.ativo ? 'justify-end bg-primary' : 'justify-start'"
                           @click="row.ativo = !row.ativo">
                      <div class="h-5 w-5 rounded-full bg-white shadow-md transition-all"></div>
                      <input type="checkbox" 
                             x-model="row.ativo"
                             class="invisible absolute peer" />
                    </label>
                  </td>
                  <td class="py-3 px-4 min-w-[150px]">
                    <template x-if="hasErrors(index)">
                      <div class="text-xs text-red-600 dark:text-red-400">
                        <ul class="list-disc list-inside">
                          <template x-for="error in getErrors(index)" :key="error">
                            <li x-text="error"></li>
                          </template>
                        </ul>
                      </div>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <!-- Campo hidden para parsed_data (sem flags _auto_price / _cost_invalid) -->
    <%= f.hidden_field :parsed_data, value: "", "x-bind:value": "JSON.stringify(rowsForSubmit())" %>

    <!-- Botões de Ação -->
    <div class="flex-shrink-0 pt-4 pb-2 flex gap-4">
      <%= render 'shared/ui/button',
          text: "Salvar alterações",
          variant: :secondary,
          size: :lg,
          type: :submit,
          class: "flex-1" %>
      
      <% unless @product_import.status == 'completed' %>
        <%= render 'shared/ui/button',
            text: "Confirmar importação",
            variant: :primary,
            size: :lg,
            type: :button,
            class: "flex-1",
            "@click": "confirmImport()" %>
      <% end %>
    </div>
  <% end %>

  <!-- Formulário para processar importação -->
  <%= form_with url: process_import_backoffice_product_import_path(@product_import), method: :post, local: true, id: "process-form", style: "display: none;" do |f| %>
    <%= hidden_field_tag :parsed_data, "", "x-bind:value": "JSON.stringify(rowsForSubmit())" %>
  <% end %>
  </main>
</div>

