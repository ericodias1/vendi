<%
  products = local_assigns[:products]
  selected_product_ids = local_assigns[:selected_product_ids] || []
  all_page_selected = products.size > 0 && products.all? { |p| selected_product_ids.include?(p.id) }
  redirect_query = { filter: params[:filter], search: params[:search], page: params[:page] }
%>

<div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden mb-32">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
      <thead class="bg-slate-50 dark:bg-slate-800/50">
        <tr>
          <th scope="col" class="px-2 py-3 text-left w-10" onclick="event.stopPropagation()">
            <% if products.any? %>
              <%= form_with url: all_page_selected ? remove_backoffice_labels_products_path(redirect_query) : add_backoffice_labels_products_path(redirect_query),
                  method: :post,
                  class: "inline" do |f| %>
                <% products.each do |p| %>
                  <%= hidden_field_tag "product_ids[]", p.id, id: nil %>
                <% end %>
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox"
                         class="checkbox-primary cursor-pointer"
                         <%= "checked" if all_page_selected %>
                         onchange="this.form.submit()" />
                </label>
              <% end %>
            <% end %>
          </th>
          <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            SKU
          </th>
          <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            Nome
          </th>
          <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider hidden md:table-cell">
            Variação
          </th>
          <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            Preço
          </th>
          <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            Estoque
          </th>
          <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            Status
          </th>
          <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">
            <span class="sr-only">Ações</span>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-surface-dark divide-y divide-slate-100 dark:divide-slate-800">
        <% products.each do |product| %>
          <% decorated = decorate(product) %>
          <% selected = selected_product_ids.include?(product.id) %>
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors cursor-pointer" onclick="window.location='<%= backoffice_product_path(product) %>'">
            <%= render 'label_checkbox_cell', product: product, selected: selected, redirect_query: redirect_query %>
            <!-- SKU -->
            <td class="px-4 py-3">
              <% if product.sku.present? %>
                <span class="text-sm text-slate-600 dark:text-slate-400 font-mono">
                  <%= product.sku %>
                </span>
              <% else %>
                <span class="text-sm text-slate-400 dark:text-slate-500">—</span>
              <% end %>
            </td>
            
            <!-- Nome -->
            <td class="px-4 py-3">
              <p class="text-sm font-semibold text-slate-900 dark:text-white truncate max-w-[250px]">
                <%= product.name %>
              </p>
            </td>
            
            <!-- Variação -->
            <td class="px-4 py-3 hidden md:table-cell">
              <% variation = decorated.display_variation %>
              <% if variation.present? && variation != "Sem variação" %>
                <span class="text-sm text-slate-600 dark:text-slate-400">
                  <%= variation %>
                </span>
              <% else %>
                <span class="text-sm text-slate-400 dark:text-slate-500">—</span>
              <% end %>
            </td>
            
            <!-- Preço -->
            <td class="px-4 py-3 text-right">
              <span class="text-sm font-semibold text-slate-900 dark:text-white">
                <%= decorated.formatted_price %>
              </span>
            </td>
            
            <!-- Estoque (quantidade) -->
            <td class="px-4 py-3 text-center">
              <span class="text-sm font-medium text-slate-700 dark:text-slate-300">
                <%= product.stock_quantity %>
              </span>
            </td>
            
            <!-- Status (badge) -->
            <td class="px-4 py-3 text-center">
              <%= render 'shared/ui/badge', 
                  text: decorated.stock_badge_text, 
                  variant: decorated.stock_badge_variant,
                  class: "text-[10px] font-bold uppercase tracking-wider" %>
            </td>
            
            <!-- Ações -->
            <td class="px-4 py-3 text-right" onclick="event.stopPropagation()">
              <%= button_to backoffice_product_quick_sale_path(product),
                  method: :post,
                  form: { onclick: "event.stopPropagation()", class: "inline" },
                  class: "inline-flex items-center justify-center w-8 h-8 rounded-lg text-primary hover:bg-primary/10 transition-colors mr-1 border-0 bg-transparent cursor-pointer",
                  title: "Venda rápida" do %>
                <span class="material-symbols-outlined text-xl">bolt</span>
              <% end %>
              <%= link_to backoffice_product_path(product),
                  class: "inline-flex items-center justify-center w-8 h-8 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:text-slate-300 dark:hover:bg-slate-800 transition-colors" do %>
                <span class="material-symbols-outlined text-xl">chevron_right</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
