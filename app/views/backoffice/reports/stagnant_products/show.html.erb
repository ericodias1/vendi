<div class="max-w-7xl mx-auto">
  <%= render 'backoffice/reports/shared/report_header',
      title: "Produtos Parados" %>

  <!-- Card de Insights -->
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <div class="flex flex-col gap-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <%= render 'shared/ui/heading',
              text: "Dinheiro travado em estoque",
              size: :lg,
              class: "mb-1" %>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Produtos com estoque parado e alto custo total, para ajudar a liberar capital.
          </p>
        </div>

        <div class="text-right shrink-0">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
            Total parado
          </p>
          <p class="text-2xl font-bold text-red-600 dark:text-red-400">
            <%= price_display(@insights[:total_stuck_value].to_f) %>
          </p>
        </div>
      </div>

      <% if @insights[:top_categories].present? %>
        <div>
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
            Categorias que mais travam dinheiro
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <% @insights[:top_categories].each do |row| %>
              <div class="flex items-center justify-between gap-3 p-4 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 rounded-lg">
                <div class="min-w-0">
                  <p class="text-sm font-semibold text-[#0e1b12] dark:text-white truncate">
                    <%= row[:category] %>
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    <%= row[:product_count] %> <%= row[:product_count] == 1 ? "produto" : "produtos" %>
                  </p>
                </div>
                <p class="text-sm font-bold text-red-600 dark:text-red-400 shrink-0">
                  <%= price_display(row[:total_stuck_value].to_f) %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Ações sugeridas (placeholder): TODO: AI suggestions -->

  <!-- Tabela de Produtos -->
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <%= render 'shared/ui/heading',
        text: "Produtos",
        size: :lg,
        class: "mb-4" %>

    <% if @products.any? %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-800">
              <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Produto</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estoque</th>
              <th class="text-right py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Custo total parado</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Dias sem vender</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Última venda</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
            <% @products.each do |product_data| %>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <!-- Produto -->
                <td class="py-4 px-4">
                  <%= render 'backoffice/reports/shared/product_info',
                      product: product_data.product,
                      product_name: product_data.product_name %>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Categoria: <%= product_data.category %>
                  </p>
                </td>

                <!-- Estoque -->
                <td class="py-4 px-4 text-center">
                  <span class="text-sm font-semibold text-[#0e1b12] dark:text-white">
                    <%= product_data.stock_quantity %>
                  </span>
                </td>

                <!-- Custo total parado -->
                <td class="py-4 px-4 text-right">
                  <span class="text-sm font-bold text-red-600 dark:text-red-400">
                    <%= price_display(product_data.total_cost_stuck.to_f) %>
                  </span>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    Custo/un: <%= price_display(product_data.cost_price.to_f) %>
                  </p>
                </td>

                <!-- Dias sem vender -->
                <td class="py-4 px-4 text-center">
                  <div class="flex flex-col items-center gap-1">
                    <span class="text-sm font-semibold text-[#0e1b12] dark:text-white">
                      <%= product_data.days_without_selling %>
                    </span>
                    <% if product_data.days_without_selling.to_i > 30 %>
                      <%= render 'shared/ui/badge',
                          text: "ALERTA",
                          variant: :warning,
                          class: "text-[10px] font-bold uppercase tracking-wider" %>
                    <% end %>
                    <p class="text-[11px] text-gray-500 dark:text-gray-400">
                      <%= format_days_without_selling(product_data.days_without_selling) %>
                    </p>
                  </div>
                </td>

                <!-- Última venda -->
                <td class="py-4 px-4 text-center">
                  <span class="text-sm text-gray-700 dark:text-gray-300">
                    <%= format_last_sale_date(product_data.last_sale_date) %>
                  </span>
                </td>

                <!-- Ações -->
                <td class="py-4 px-4 text-center">
                  <%= link_to backoffice_product_path(product_data.product),
                      class: "inline-flex items-center gap-1 text-xs font-semibold text-primary hover:underline" do %>
                    Ver produto
                    <span class="material-symbols-outlined text-sm">chevron_right</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-12">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-4">
          <span class="material-symbols-outlined text-3xl text-gray-400">inventory_2</span>
        </div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
          Nenhum produto parado encontrado
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          Quando houver produtos com estoque e baixa saída, eles aparecerão aqui.
        </p>
      </div>
    <% end %>
  <% end %>

  <!-- Card de Informações -->
  <%= render 'backoffice/reports/shared/info_card',
      title: "Como funciona este relatório?",
      items: [
        "O relatório mostra apenas produtos <strong>ativos</strong> com <strong>estoque acima de 0</strong>",
        "Os <strong>dias sem vender</strong> são calculados a partir da última venda (ou da data de criação quando nunca vendeu)",
        "O <strong>custo total parado</strong> é calculado como: <strong>estoque atual × custo do produto</strong>",
        "As <strong>categorias</strong> são usadas para mostrar onde o dinheiro está mais concentrado"
      ] %>
</div>
