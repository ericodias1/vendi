<div class="max-w-7xl mx-auto">
  <%= render 'backoffice/reports/shared/report_header',
      title: "Sugestão de Reposição" %>

  <!-- Card de Insights -->
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <div class="flex flex-col gap-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <%= render 'shared/ui/heading',
              text: "Lista de compra sugerida",
              size: :lg,
              class: "mb-1" %>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Baseado em giro (últimos <%= @insights[:sales_lookback_days] %> dias), lucro e um método híbrido (cobertura + estoque mínimo).
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 rounded-lg">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
            Unidades sugeridas
          </p>
          <p class="text-2xl font-bold text-[#0e1b12] dark:text-white">
            <%= @insights[:total_units].to_i %>
          </p>
        </div>

        <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 rounded-lg">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
            Custo estimado
          </p>
          <p class="text-2xl font-bold text-[#0e1b12] dark:text-white">
            <%= price_display(@insights[:total_cost].to_f) %>
          </p>
        </div>

        <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 rounded-lg">
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">
            Lucro potencial (estimado)
          </p>
          <p class="text-2xl font-bold" style="color: var(--color-vendi-green-500);">
            <%= price_display(@insights[:total_profit].to_f) %>
          </p>
        </div>
      </div>

      <% if @insights[:top_categories].present? %>
        <div>
          <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
            Categorias com maior investimento sugerido
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <% @insights[:top_categories].each do |row| %>
              <div class="flex items-center justify-between gap-3 p-4 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-800 rounded-lg">
                <div class="min-w-0">
                  <p class="text-sm font-semibold text-[#0e1b12] dark:text-white truncate">
                    <%= row[:category] %>
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    <%= row[:product_count] %> <%= row[:product_count] == 1 ? "produto" : "produtos" %>
                  </p>
                </div>
                <p class="text-sm font-bold text-[#0e1b12] dark:text-white shrink-0">
                  <%= price_display(row[:total_cost].to_f) %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Tabela de Reposição -->
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <%= render 'shared/ui/heading',
        text: "Sugestões",
        size: :lg,
        class: "mb-4" %>

    <% if @suggestions.any? %>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-800">
              <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Produto</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estoque</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Venda média/dia</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sugestão</th>
              <th class="text-right py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Custo estimado</th>
              <th class="text-right py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Lucro potencial</th>
              <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Motivo</th>
              <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ação</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
            <% @suggestions.each do |row| %>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="py-4 px-4">
                  <%= render 'backoffice/reports/shared/product_info',
                      product: row.product,
                      product_name: row.product_name %>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Categoria: <%= row.category %>
                  </p>
                </td>

                <td class="py-4 px-4 text-center">
                  <span class="text-sm font-semibold text-[#0e1b12] dark:text-white">
                    <%= row.stock_quantity %>
                  </span>
                </td>

                <td class="py-4 px-4 text-center">
                  <span class="text-sm font-semibold text-[#0e1b12] dark:text-white">
                    <%= number_with_precision(row.avg_sales_per_day.to_f, precision: 2) %>
                  </span>
                </td>

                <td class="py-4 px-4 text-center">
                  <span class="text-sm font-bold text-primary">
                    <%= row.suggested_qty %>
                  </span>
                </td>

                <td class="py-4 px-4 text-right">
                  <span class="text-sm font-semibold text-[#0e1b12] dark:text-white">
                    <%= price_display(row.suggested_cost.to_f) %>
                  </span>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    Custo/un: <%= price_display(row.cost_price.to_f) %>
                  </p>
                </td>

                <td class="py-4 px-4 text-right">
                  <% if row.suggested_profit.to_f.positive? %>
                    <span class="text-sm font-bold" style="color: var(--color-vendi-green-500);">
                      <%= price_display(row.suggested_profit.to_f) %>
                    </span>
                  <% else %>
                    <span class="text-sm text-gray-400 dark:text-gray-500">
                      <%= price_display(row.suggested_profit.to_f) %>
                    </span>
                  <% end %>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    Preço médio: <%= price_display(row.avg_selling_price.to_f) %>
                  </p>
                </td>

                <td class="py-4 px-4">
                  <span class="text-xs text-gray-700 dark:text-gray-300">
                    <%= row.reason %>
                  </span>
                </td>

                <td class="py-4 px-4 text-center">
                  <%= link_to backoffice_product_path(row.product),
                      class: "inline-flex items-center gap-1 text-xs font-semibold text-primary hover:underline" do %>
                    Ver produto
                    <span class="material-symbols-outlined text-sm">chevron_right</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-12">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-4">
          <span class="material-symbols-outlined text-3xl text-gray-400">shopping_cart</span>
        </div>
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
          Nenhuma sugestão de reposição no momento
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          Isso acontece quando o estoque atual já cobre a meta ou quando os itens sem giro já estão acima do estoque mínimo.
        </p>
      </div>
    <% end %>
  <% end %>

  <!-- Card de Informações -->
  <%= render 'backoffice/reports/shared/info_card',
      title: "Como funciona este relatório?",
      items: [
        "Produtos com giro usam a regra de <strong>cobertura</strong>: sugerimos comprar até atingir #{@insights[:coverage_target_days]} dias com base na venda média dos últimos #{@insights[:sales_lookback_days]} dias",
        "Produtos sem giro usam a regra de <strong>estoque mínimo</strong>: sugerimos comprar até atingir #{@insights[:min_stock_target]} unidades",
        "O relatório considera apenas produtos com <strong>custo cadastrado</strong>",
        "O <strong>custo estimado</strong> é calculado como: custo do produto × quantidade sugerida",
        "O <strong>lucro potencial</strong> é estimado como: (preço médio de venda − custo) × quantidade sugerida"
      ] %>
</div>
