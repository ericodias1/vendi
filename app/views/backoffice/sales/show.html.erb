<div class="mb-6">
  <div class="flex items-center justify-between mb-4">
    <%= render 'shared/ui/back_link', path: backoffice_sales_path %>
    <div class="flex items-center gap-2">
      <%= sale_status_badge(@sale) %>
    </div>
  </div>

  <!-- Header -->
  <div class="mb-6">
    <%= render 'shared/ui/heading', text: "##{@sale.sale_number}", size: :xl, class: "mb-2" %>
    <p class="text-sm text-slate-500">
      <%= @sale.created_at.strftime("%d/%m/%Y às %H:%M") %>
    </p>
  </div>
</div>

<!-- Itens da Venda -->
<%= render 'shared/ui/card', class: "mb-6" do %>
  <%= render 'shared/ui/heading', text: "Itens da Venda", size: :md, class: "mb-4 text-slate-400 uppercase tracking-widest" %>
  <div class="space-y-4">
    <% @sale.sale_items.each do |item| %>
      <div class="flex items-start gap-4 pb-4 border-b border-slate-100 last:border-0 last:pb-0">
        <div class="w-16 h-16 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0">
          <% if item.product&.images&.attached? %>
            <%= image_tag item.product.images.first, alt: item.product_name, class: "w-full h-full object-cover" %>
          <% else %>
            <div class="w-full h-full flex items-center justify-center">
              <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
          <% end %>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-slate-900 mb-1">
            <%= item.product_name %>
            <% if item.display_variation != "Sem variação" %>
              — <%= item.display_variation %>
            <% end %>
          </p>
          <p class="text-sm text-slate-500">
            <%= item.quantity %> × <%= number_to_currency(item.unit_price, unit: "R$ ", separator: ",", delimiter: ".") %>
          </p>
        </div>
        <div class="text-right">
          <p class="font-semibold text-slate-900">
            <%= number_to_currency(item.total_amount, unit: "R$ ", separator: ",", delimiter: ".") %>
          </p>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<!-- Resumo Financeiro -->
<%= render 'shared/ui/card', class: "mb-6" do %>
  <%= render 'shared/ui/heading', text: "Resumo Financeiro", size: :md, class: "mb-4 text-slate-400 uppercase tracking-widest" %>
  <div class="space-y-2">
    <div class="flex justify-between text-sm text-slate-600">
      <span>Subtotal</span>
      <span><%= number_to_currency(@sale.subtotal, unit: "R$ ", separator: ",", delimiter: ".") %></span>
    </div>
    <% if @sale.discount_amount > 0 %>
      <div class="flex justify-between text-sm text-slate-600">
        <span>Desconto</span>
        <span class="text-red-600">
          -<%= number_to_currency(@sale.discount_amount, unit: "R$ ", separator: ",", delimiter: ".") %>
          <% if @sale.discount_percentage.present? %>
            (<%= number_with_precision(@sale.discount_percentage, precision: 1) %>%)
          <% end %>
        </span>
      </div>
    <% end %>
    <div class="flex justify-between items-center pt-3 mt-3 border-t border-slate-200">
      <span class="font-bold text-lg text-slate-900">Total</span>
      <span class="text-2xl font-bold" style="color: var(--color-vendi-green-500);">
        <%= number_to_currency(@sale.total_amount, unit: "R$ ", separator: ",", delimiter: ".") %>
      </span>
    </div>
  </div>
<% end %>

<!-- Pagamento -->
<% if @sale.payment %>
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <%= render 'shared/ui/heading', text: "Pagamento", size: :md, class: "mb-4 text-slate-400 uppercase tracking-widest" %>
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-slate-500 font-medium mb-1">Método</p>
          <p class="font-semibold text-slate-900 uppercase">
            <% if @sale.payment %>
              <%= case @sale.payment.method
                  when "pix"
                    "Pix"
                  when "credit_card"
                    "Cartão de Crédito"
                  when "debit_card"
                    "Cartão de Débito"
                  when "cash"
                    "Dinheiro"
                  when "fiado"
                    "Fiado"
                  else
                    @sale.payment.method.humanize
                  end %>
            <% else %>
              Sem pagamento
            <% end %>
          </p>
        </div>
        <div>
          <p class="text-xs text-slate-500 font-medium mb-1">Status</p>
          <% payment_status_label = case @sale.payment.status
               when "paid"
                 "Pago"
               when "pending"
                 "Pendente"
               when "processing"
                 "Processando"
               when "failed"
                 "Falhou"
               when "refunded"
                 "Reembolsado"
               else
                 @sale.payment.status.humanize
             end %>
          <%= render 'shared/ui/badge', 
              text: payment_status_label, 
              variant: @sale.payment.paid? ? :success : :warning %>
        </div>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-slate-500">Valor</span>
        <span class="font-semibold text-slate-900">
          <%= number_to_currency(@sale.payment.amount, unit: "R$ ", separator: ",", delimiter: ".") %>
        </span>
      </div>
      <% if @sale.payment.installments.present? && @sale.payment.installments > 1 %>
        <div class="flex justify-between text-sm">
          <span class="text-slate-500">Parcelas</span>
          <span class="font-semibold text-slate-900">
            <%= @sale.payment.installments %>× de <%= number_to_currency(@sale.payment.amount / @sale.payment.installments, unit: "R$ ", separator: ",", delimiter: ".") %>
          </span>
        </div>
      <% end %>
      <% if @sale.payment.paid_at.present? %>
        <div class="flex justify-between text-sm">
          <span class="text-slate-500">Pago em</span>
          <span class="font-semibold text-slate-900">
            <%= @sale.payment.paid_at.strftime("%d/%m/%Y às %H:%M") %>
          </span>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>

<!-- Cliente -->
<% if @sale.customer %>
  <%= render 'shared/ui/card', class: "mb-6" do %>
    <%= render 'shared/ui/heading', text: "Cliente", size: :md, class: "mb-4 text-slate-400 uppercase tracking-widest" %>
    <div class="space-y-2">
      <p class="font-semibold text-slate-900"><%= @sale.customer.name %></p>
      <% if @sale.customer.phone.present? %>
        <p class="text-sm text-slate-600"><%= @sale.customer.phone %></p>
      <% end %>
      <% if defined?(backoffice_customers_path) %>
        <%= link_to "#", class: "text-sm text-primary hover:underline", style: "color: var(--color-vendi-green-500);" do %>
          Ver histórico do cliente →
        <% end %>
      <% end %>
    </div>
  <% end %>
<% end %>

<!-- Ações -->
<div class="space-y-3">
  <% if @sale.pending_payment? %>
    <%= form_with url: complete_backoffice_sale_path(@sale), method: :patch, local: true, class: "w-full" do |f| %>
      <%= render 'shared/ui/button',
          text: "Confirmar pagamento",
          variant: :primary,
          type: :submit,
          class: "w-full" %>
    <% end %>
    
    <%= form_with url: send_payment_link_backoffice_sale_path(@sale), method: :post, local: true, class: "w-full" do |f| %>
      <%= render 'shared/ui/button',
          text: "Reenviar link WhatsApp",
          variant: :secondary,
          type: :submit,
          class: "w-full" %>
    <% end %>
  <% end %>

  <% if @sale.can_cancel? %>
    <%= form_with url: backoffice_sale_path(@sale), method: :delete, local: true, class: "w-full", data: { confirm: "Tem certeza que deseja cancelar esta venda? O estoque será revertido." } do |f| %>
      <%= f.text_area :cancellation_reason, 
          placeholder: "Motivo do cancelamento (opcional)",
          class: "w-full mb-3 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" %>
      <%= render 'shared/ui/button',
          text: "Cancelar venda",
          variant: :danger,
          type: :submit,
          class: "w-full" %>
    <% end %>
  <% end %>

  <% if @sale.cancelled? %>
    <div class="bg-red-50 border border-red-200 rounded-xl p-4">
      <p class="text-sm font-semibold text-red-900 mb-1">Venda cancelada</p>
      <% if @sale.cancellation_reason.present? %>
        <p class="text-sm text-red-700 mb-2"><%= @sale.cancellation_reason %></p>
      <% end %>
      <p class="text-xs text-red-600">
        Cancelada em <%= @sale.cancelled_at.strftime("%d/%m/%Y às %H:%M") %>
      </p>
    </div>
  <% end %>
</div>
