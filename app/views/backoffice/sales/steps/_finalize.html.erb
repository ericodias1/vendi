<%
  sale = local_assigns[:sale]
  
  # Calcular totais
  subtotal = sale.subtotal || sale.sale_items.sum(&:subtotal)
  discount = sale.discount_amount || 0
  total = sale.total_amount || (subtotal - discount)
  
  # Verificar estoque
  stock_issues = []
  sale.sale_items.each do |sale_item|
    product = sale_item.product
    if product.stock_quantity < sale_item.quantity
      stock_issues << { product: product, requested: sale_item.quantity, available: product.stock_quantity }
    end
  end
  
  payment_method_label = case sale.payment&.method
  when "pix"
    "Pix"
  when "credit_card"
    "Cartão de Crédito"
  when "debit_card"
    "Cartão de Débito"
  when "cash"
    "Dinheiro"
  when "fiado"
    "Fiado"
  else
    sale.payment&.method&.humanize || "Não selecionado"
  end
%>

<div data-controller="sale-form" data-sale-form-step-value="3">
  <%= render 'shared/ui/step_header', 
      title: "Confirmar venda", 
      current_step: 3, 
      total_steps: 3,
      back_path: edit_backoffice_sale_details_path(sale),
      class: "pt-12" %>

  <main class="flex-1 px-4 pb-32">
    <div class="bg-white rounded-[var(--card-radius)] ios-shadow overflow-hidden mb-6" style="--card-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);">
      <!-- Forma de Pagamento -->
      <div class="p-5 border-b border-slate-50">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-[var(--primary)]" style="--primary: #22C55E;">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <div>
              <p class="text-xs text-slate-500 font-medium">Forma de pagamento</p>
              <p class="font-semibold text-slate-800 uppercase"><%= payment_method_label %></p>
            </div>
          </div>
          <%= render 'shared/ui/button', 
              text: "Alterar", 
              href: edit_backoffice_sale_details_path(sale),
              variant: :tertiary,
              size: :sm,
              class: "text-xs" %>
        </div>
      </div>

      <!-- Cliente -->
      <% if sale.customer.present? %>
        <div class="p-5 border-b border-slate-50">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                <span class="material-symbols-outlined text-xl">person</span>
              </div>
              <div>
                <p class="text-xs text-slate-500 font-medium">Cliente</p>
                <p class="font-semibold text-slate-800"><%= sale.customer.name %></p>
                <% if sale.customer.phone.present? %>
                  <p class="text-xs text-slate-400 mt-0.5"><%= sale.customer.phone %></p>
                <% end %>
              </div>
            </div>
            <%= render 'shared/ui/button', 
                text: "Alterar", 
                href: edit_backoffice_sale_details_path(sale),
                variant: :tertiary,
                size: :sm,
                class: "text-xs" %>
          </div>
        </div>
      <% end %>

      <!-- Itens da Venda -->
      <div class="p-5 border-b border-slate-50">
        <%= render 'shared/ui/heading', text: "Itens da venda", size: :md, class: "mb-4 text-slate-400 uppercase tracking-widest text-xs" %>
        <div class="space-y-4">
          <% sale.sale_items.each do |sale_item| %>
            <div class="flex justify-between items-start">
              <div class="max-w-[70%]">
                <p class="text-sm font-medium text-slate-700">
                  <%= sale_item.product_name %>
                  <% if sale_item.product_size.present? %>
                    — Tam <%= sale_item.product_size %>
                  <% end %>
                </p>
                <p class="text-xs text-slate-400"><%= sale_item.quantity %> <%= sale_item.quantity == 1 ? 'unidade' : 'unidades' %></p>
              </div>
              <p class="text-sm font-semibold text-slate-700">
                <%= number_to_currency(sale_item.total_amount, unit: "R$ ", separator: ",", delimiter: ".") %>
              </p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Resumo Financeiro -->
      <div class="p-5 bg-slate-50/50">
        <div class="space-y-2">
          <div class="flex justify-between text-sm text-slate-500">
            <span>Subtotal</span>
            <span><%= number_to_currency(subtotal, unit: "R$ ", separator: ",", delimiter: ".") %></span>
          </div>
          <div class="flex justify-between text-sm text-slate-500">
            <span>Desconto</span>
            <span><%= number_to_currency(discount, unit: "R$ ", separator: ",", delimiter: ".") %></span>
          </div>
          <div class="flex justify-between items-center pt-2 mt-2 border-t border-slate-100">
            <span class="font-bold text-slate-800">Total</span>
            <span class="text-xl font-bold text-[var(--primary)]" style="--primary: #22C55E;">
              <%= number_to_currency(total, unit: "R$ ", separator: ",", delimiter: ".") %>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerta de Estoque -->
    <% if stock_issues.any? %>
      <div class="bg-amber-50 border border-amber-100 rounded-[var(--card-radius)] p-4 mb-6" style="--card-radius: 16px;">
        <div class="flex items-start gap-3 mb-3">
          <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="text-sm text-amber-800 leading-tight">
            <span class="font-bold block">Atenção</span>
            Estoque insuficiente em <%= stock_issues.count %> <%= stock_issues.count == 1 ? 'item selecionado' : 'itens selecionados' %>.
          </p>
        </div>
        <div class="flex gap-4 ml-9">
          <%= link_to backoffice_products_path, class: "text-xs font-bold text-amber-600 uppercase tracking-wide" do %>
            Ajustar estoque
          <% end %>
          <button type="button" class="text-xs font-bold text-amber-600 uppercase tracking-wide">Vender mesmo assim</button>
        </div>
      </div>
    <% end %>
  </main>

  <!-- Fixed Footer Button -->
  <div class="fixed-footer">
    <%= form_with url: backoffice_sale_finalize_path(sale), method: :patch, local: true do |f| %>
      <%= f.hidden_field :payment_received, value: (sale.payment&.method == "cash" ? "1" : "0") %>

      <%= render 'shared/ui/button',
          text: "Confirmar venda",
          type: :submit,
          variant: :primary,
          size: :lg,
          width: "w-full",
          class: "rounded-2xl shadow-lg shadow-green-200" %>
    <% end %>
    <div class="h-6"></div>
  </div>
</div>
